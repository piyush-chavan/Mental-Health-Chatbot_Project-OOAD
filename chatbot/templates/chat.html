<!DOCTYPE html>
<html>
<head>
    <title>Chatbot</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <link rel="stylesheet" href="/static/css/custom.css">
</head>
<body>

<div class="navbar">
    {% if request.user.is_authenticated %}
    <div class="profile-circle">{{request.user.username.0}}</div>
    {% else %}
    <div class="profile-circle">G</div>
    {% endif %}

    {% if request.user.is_authenticated %}
    
    <div class="logout-login">
        
        <a class="logout-link" href="{% url 'logout' %}">Logout</a>
        {% else %}
        <div class="auth-links">
            <a class="login-link" href="{% url 'login' %}">Signin</a>
            <a class="register-link" href="{% url 'register' %}">Register</a>
        </div>
        {% endif %}
    </div>
</div>

<div class="container">
    <div class="sidebar">
        {% if request.user.is_authenticated %}
        <div class = "welcome" >Welcome {{request.user.username}}</div>
        <ul id="chatHistoryList">
            <!-- Render chat history grouped by date here -->
        </ul>
        {% endif %}
        <!-- Add additional sidebar content here -->
    </div>
    <div class="chat-window">
        <div class="messages" id="chatbox">
            
            <!-- Add more chat messages here -->
        </div>
        <div class="input-bar">
            <form method="post" id="userInputForm" class="input-form">
                {% csrf_token %}
                {{ form.message }}
                <input type="submit"  class="input-button" id="post_button" value="Send">
            </form>
        </div>
    </div>
</div>

<script>
    const addDivForm = document.getElementById("userInputForm");
    const container = document.getElementById("chatbox");

    function renderChatMessages(messages) {
        const chatbox = document.getElementById('chatbox');
        chatbox.innerHTML = '';

        for (const message of messages) {
            const usermessageDiv = document.createElement('div');
            const botmessageDiv = document.createElement('div');
            usermessageDiv.className = 'message user-message';
            botmessageDiv.className = 'message bot-message';
            usermessageDiv.textContent = message.user;
            botmessageDiv.textContent = message.bot

            

            chatbox.appendChild(usermessageDiv);
            chatbox.appendChild(botmessageDiv);
        }
    }

    // Load chat history by date and render in the sidebar
    $.ajax({
    url: "/load_chats/",
    method: "GET",
    success: function (data) {
        const chatHistoryList = document.getElementById('chatHistoryList');

        data.dates.forEach((chatItem) => {
            const listItem = document.createElement('li');
            listItem.textContent = chatItem.date;
            listItem.className = 'chat-date';

            // Add click handler to load chats for the selected date
            listItem.addEventListener('click', function () {
                // Format the selected date as needed
                const selectedDate = chatItem.date;

                $.ajax({
                    url: "/load_chat/",
                    method: "GET",
                    data: { date: selectedDate },
                    success: function (chatData) {
                        console.log(chatData);
                        renderChatMessages(chatData.chat);
                    },
                    error: function (xhr, status, error) {
                        console.error("Error:", error);
                    }
                });
            });

            chatHistoryList.appendChild(listItem);
        });
    },
    error: function (xhr, status, error) {
        console.error("Error:", error);
    }
});

    

    addDivForm.addEventListener("submit", function (event) {
        event.preventDefault();
        const userMessage = document.querySelector('input[name="message"]').value;
        const csrftoken = getCookie("csrftoken");

        $.ajax({
            url: "/chat/",  // URL to the chat_view
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken
            },

            data: { message: userMessage },  // Replace with the user's input if needed
            success: function (data) {
                const botResponse = document.createElement("div");
                const userResponse = document.createElement("div");
                botResponse.className = "message bot-message";
                userResponse.className = "message user-message";

                // Populate the new div with the response from the Django server
                botResponse.textContent = data.response;
                userResponse.textContent = data.message;

                // Append the new div to the container
                container.appendChild(userResponse);
                container.appendChild(botResponse);
                var targetElement = botResponse;

                // Define the scroll behavior (smooth or auto)
                var scrollBehavior = 'smooth'; // 'smooth' for smooth scrolling, 'auto' for instant scrolling

    if (targetElement) {
        targetElement.scrollIntoView({ behavior: scrollBehavior });
    }
            },
            error: function (xhr, status, error) {
                console.error("Error:", error);
            }
        });
        document.querySelector('input[name="message"]').value = "";
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === name + "=") {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

</body>
</html>
