<!DOCTYPE html>
<html>

<head>
    <title>Chatbot</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        html,
        body {
            height: 100%;
            overflow: hidden;
            margin: 0;
        }

        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            height: 4%;
            justify-content: space-between;
            background: #128C7E;
            color: #fff;
            padding: 10px 20px;
        }

        .container {
            padding-top: 3%;
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: #128C7E;
            color: #fff;
            padding: 20px;
        }

        .profile {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 0px;
        }

        .profile-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #fff;
            color: #128C7E;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 15px;
            text-decoration: none;
        }

        .profile-circle:hover {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #15eb20;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 15px;
            text-decoration: none;
        }

        .logout-link {
            color: #fff;
            text-decoration: none;
            background-color: #2bc7b5;
            padding: 10px;
            margin-bottom: 10px;
            margin-left: 0px;
        }

        .auth-links {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-top: 10px;
            margin-left: auto;

        }

        .login-link,
        .register-link {
            color: #fff;
            text-decoration: none;
            background-color: #15c0ac;
            padding: 10px;
            margin-left: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .welcome {

            color: #fff;
            padding-top: 20px;
            margin-left: 0px;
            font-size: 18px;
            margin-top: 20px;
        }

        .chat-window {
            flex: 1;
            background: #fff;
            display: flex;
            flex-direction: column;
            overflow: auto;
        }

        .chatHistory {

            margin-top: 20px;
            list-style: none;
            height: calc(100% - 150px);
            overflow-y: auto;
        }

        .chatHistory::-webkit-scrollbar {
            width: 12px;
            margin-left: 5px;
        }

        .chatHistory::-webkit-scrollbar-thumb {
            background: #15c0ac;
            border-radius: 6px;
        }

        .chatHistory::-webkit-scrollbar-track {
            background: #128C7E;
            border-radius: 6px;
        }

        .chatHistory::-webkit-scrollbar-thumb:hover {
            background: #15c0ac;
        }

        li.chat-date {
            color: #fff;
            margin-top: 20px;
            font-size: 20px;
            border-bottom: 1px solid #fff;
            cursor: pointer;
        }

        li.chat-date:hover {
            background-color: rgb(21, 203, 21);

        }


        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: scroll;
            display: flex;
            flex-direction: column;
            margin-bottom: 100px;
            margin-top: 50px;
        }

        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 10px;
        }

        .user-message {
            align-self: flex-end;
            background: #DCF8C6;
            padding: 10px;
            border-radius: 10px;
        }

        .bot-message {
            align-self: flex-start;
            background: #EDEDED;
            margin-right: auto;
            white-space: pre-line;
        }

        .input-bar {
            position: fixed;
            bottom: 0;
            left: 270px;
            right: 0px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .input-form {
            display: flex;
            flex: 1;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .input-box {
            flex: 1;
            width: 100%;
            background: #DCF8C6;
            padding: 10px;
            border-radius: 10px;
        }

        .input-button {
            background: #128C7E;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        .box {
            margin: auto;
            padding: 0;
            padding-left: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-image: url("https://img.freepik.com/free-vector/global-data-security-personal-data-security-cyber-data-security-online-concept-illustration-internet-security-information-privacy-protection_1150-37336.jpg?size=626&ext=jpg&uid=R123926771&semt=sph");
        }

        .options-container {
            margin-top: 30px;
            margin-bottom: 30px;

        }

        .option {
            margin: 10px;
        }

        .next-button {
            align-self: flex-end;
            background: #DCF8C6;
            margin-right: 50px;
            margin-bottom: 20px;
            padding: 10px;
            padding-left: 20px;
            padding-right: 20px;
            border-radius: 10px;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playpen+Sans&display=swap" rel="stylesheet">
</head>

<body>

    <div class="navbar">
        {% if request.user.is_authenticated %}
        <!-- <a class="profile-circle" href="/">{{request.user.username.0}}</a> -->
        <a class="profile-circle" href="/"><img src="/static/img/brain_transparent.png" alt="img-logo" width="50px">
        </a>


        {% else %}
        <!-- <a class="profile-circle" href="/">G</a> -->
        <a class="profile-circle" href="/"><img src="/static/img/brain_transparent.png" alt="img-logo" width="50px">
        </a><br>
        <h2 style="font-family: 'Playpen Sans', cursive; ">Guest User</h2>
        {% endif %}

        <div class="logout-login">

        </div>

        {% if request.user.is_authenticated %}

        <div class="logout-login">
            <a class="login-link" style="font-family: 'Playpen Sans', cursive;" id="test_button">Take a Test</a>
            <a class="logout-link" style="font-family: 'Playpen Sans', cursive;" href="{% url 'logout' %}">Logout</a>

            {% else %}
            <div class="auth-links">
                <a class="login-link" style="font-family: 'Playpen Sans', cursive;" id="test_button">Take a Test</a>
                <a class="login-link" style="font-family: 'Playpen Sans', cursive;" href="{% url 'login' %}">Signin</a>
                <a class="register-link" style="font-family: 'Playpen Sans', cursive;"
                    href="{% url 'register' %}">Register</a>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            {% if request.user.is_authenticated %}
            <div class="welcome" style="font-family: 'Playpen Sans', cursive;">Welcome {{request.user.username}}</div>
            <ul id="chatHistoryList" class="chatHistory">
                <!--           ____________________dates___________________                    -->
            </ul>
            {% endif %}
        </div>

        <div class="chat-window">
            <div class="messages" id="chatbox" style="font-family: 'Playpen Sans', cursive;">

                <!-- _______________________chat messages_______________________________ -->
            </div>
            <div class="input-bar">
                <form method="post" id="userInputForm" class="input-form">
                    {% csrf_token %}
                    {{ form.message }}
                    <input type="submit" class="input-button btn" id="post_button" value="Send">
                </form>
            </div>

        </div>
    </div>

    <script>
        const addDivForm = document.getElementById("userInputForm");
        const container = document.getElementById("chatbox");
        const testButton = document.getElementById("test_button");
        const chatEnabled = true;
        var radioButtonIndex = 0;
        var testButtonEnabled = true;

        let surveyCompleted = false;
        let currentSurveyProgress = 0;

        function renderChatMessages(messages) {
            const chatbox = document.getElementById('chatbox');
            chatbox.innerHTML = '';

            function processMessage(index) {
                if (index < messages.length) {
                    const message = messages[index];
                    const user_message = message.user;
                    const bot_message = message.bot;

                    var regex = /\$(\d+)\$/;
                    var match = regex.exec(user_message);

                    if (match) {
                        var extractedNumber = match[1];
                        if (bot_message) {
                            loadSavedSurvey(extractedNumber, bot_message, () => {
                                // Continue processing the next message
                                processMessage(index + 1);
                            });
                        }
                    } else {
                        const usermessageDiv = document.createElement('div');
                        const botmessageDiv = document.createElement('div');
                        usermessageDiv.className = 'message user-message';
                        botmessageDiv.className = 'message bot-message';
                        usermessageDiv.textContent = user_message;
                        botmessageDiv.textContent = bot_message;

                        chatbox.appendChild(usermessageDiv);
                        chatbox.appendChild(botmessageDiv);

                        // Continue processing the next message
                        processMessage(index + 1);
                    }
                } else {
                    // All messages have been processed, call the callback
                    callback();
                }
            }

            // Start processing the messages from the first message
            processMessage(0);
        }
        

        function renderSurvey(questions, selectedSurvey, labels) {
            const chatbox = document.getElementById('chatbox');
            const heading = document.createElement('div');
            heading.className = "message bot-message";
            heading.textContent = "Over the last two weeks, how often have you been bothered by any of the following problems?";
            chatbox.appendChild(heading);
            const result = document.createElement('div');
            result.className = "message bot-message";
            let i = 0;
            var elem;
            const responseList = [];
            var score = 0;

            function renderNextQuestion() {
                if (i < questions.length) {
                    if (elem) {
                        elem.remove();
                    }
                    const question = questions[i];
                    const questionDiv = document.createElement('div');
                    const optionContainer = document.createElement('div');
                    optionContainer.className = 'options-container';
                    questionDiv.className = 'message bot-message';
                    questionDiv.textContent = question;

                    chatbox.appendChild(questionDiv);


                    const radioButtons = [];

                    for (let j = 0; j < labels.length; j++) {
                        const button = document.createElement('input');
                        button.type = 'radio';
                        button.name = 'survey_options' + String(radioButtonIndex);
                        button.value = j;
                        radioButtons.push(button);
                    }

                    radioButtonIndex++;



                    for (let j = 0; j < labels.length; j++) {
                        const label = document.createElement('label');
                        label.textContent = labels[j];
                        const option = document.createElement('div');
                        option.className = 'option';
                        option.appendChild(radioButtons[j]);
                        option.appendChild(label);
                        optionContainer.appendChild(option);
                    }

                    chatbox.appendChild(optionContainer);

                    const nextButton = document.createElement('button');
                    nextButton.textContent = 'Next';
                    nextButton.className = 'next-button';
                    nextButton.id = "next_button";

                    let selectedValue = null;

                    radioButtons.forEach(function (radioButton) {
                        radioButton.addEventListener('change', function () {
                            if (this.checked) {
                                selectedValue = parseInt(this.value); // Parse the value as an integer
                                if (selectedSurvey == 2) {
                                    if (i == 3 || i == 4 || i == 6 || i == 7) {
                                        selectedValue = 4 - selectedValue;
                                    }
                                }
                                console.log(selectedValue);
                            }
                        });
                    });
                    chatbox.appendChild(nextButton);
                    nextButton.addEventListener('click', function () {
                        if (selectedValue !== null) {

                            score += selectedValue;
                            console.log('Score:', score);
                            responseList.push(selectedValue);

                            console.log('pushed : ', selectedValue)
                            selectedValue = null; // Reset the selectedValue

                            if (i < questions.length) {
                                i++;
                                renderNextQuestion();
                            }
                            target_button = document.getElementById('next_button');
                            target_button.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    });


                    elem = nextButton;
                } else {
                    // Survey is completed
                    elem.remove();

                    switch (selectedSurvey) {
                        case 0:
                            if (score >= 0 && score <= 4) {
                                result.textContent = "You have no symptoms of depression";
                            } else if (score >= 5 && score <= 9) {
                                result.textContent = "It seems you have mild symptoms of depression. Here are some lifestyle changes that might help: \n \n1.  Exercise Regularly: Physical activity can boost mood and reduce symptoms of depression. Aim for at least 30 minutes of moderate exercise most days of the week. \n  2.  Maintain a Healthy Diet: Eating a balanced diet with plenty of fruits, vegetables, whole grains, and lean proteins can have a positive impact on your mood. \n 3.  Get Adequate Sleep: Make sure you're getting enough quality sleep, as sleep deprivation can worsen depression symptoms. Try to maintain a consistent sleep schedule. \n 4.  Connect with Others: Social support is crucial. Stay connected with friends and family, and consider talking to a therapist or counselor for additional support. \n  5.  Limit Alcohol and Caffeine: Excessive alcohol and caffeine consumption can worsen depression symptoms. It's best to consume them in moderation or avoid them altogether.";
                            } else if (score >= 10 && score <= 14) {
                                result.textContent = "It seems you have moderate symptoms of depression. Here are some lifestyle changes that might help: \n \n1.  Seek Professional Help: If you're experiencing moderate symptoms of depression, it's crucial to consult with a mental health professional, such as a therapist, psychiatrist, or counselor, who can provide you with tailored treatment options, including therapy and potentially medication. \n 2.  Maintain a Daily Routine: Establishing a structured daily routine can provide a sense of stability and purpose. This includes setting regular sleep and meal times. \n 3.  Exercise Regularly: Physical activity can improve mood and reduce depression symptoms. Aim for at least 30 minutes of moderate exercise on most days. \n  4.  Healthy Eating: Consume a balanced diet rich in fruits, vegetables, whole grains, and lean proteins. Proper nutrition can support your overall well-being. \n 5.  Adequate Sleep: Ensure you are getting enough quality sleep, and try to maintain a consistent sleep schedule.";
                            } else if (score >= 15 && score <= 19) {
                                result.textContent = "It seems you have moderately severe depression. Here are some lifestyle changes that might help: \n \n1.  Seek Immediate Professional Help: If you or someone you know is experiencing moderately severe depression, it's critical to consult with a mental health professional or psychiatrist as soon as possible. They can provide a comprehensive assessment and recommend appropriate treatment, which may include therapy, medication, or a combination of both. \n 2.  Safety First: If you or someone you know is in crisis or experiencing thoughts of self-harm or suicide, please seek immediate help from a crisis helpline, a mental health hotline, or go to the nearest emergency room. Safety is the top priority. \n 3.  Medication Management: If prescribed medication, it's important to take it as directed by your healthcare provider and attend regular follow-up appointments. \n 3.  Medication Management: If prescribed medication, it's important to take it as directed by your healthcare provider and attend regular follow-up appointments. \n 4.  Therapy: Consider engaging in therapy or counseling. Cognitive Behavioral Therapy (CBT), Dialectical Behavior Therapy (DBT), and other evidence-based therapeutic approaches can be effective in managing depression. \n 5.  Support System: Lean on a support network of friends and family. You don't have to go through depression alone, and loved ones can provide emotional support.";
                            } else {
                                result.textContent = "Your symptoms seems like of severe depression. Here are some lifestyle changes that might help: \n \n1.  Urgent Professional Help: If you believe you have severe symptoms of depression or are experiencing thoughts of self-harm or suicide, it's critical to seek immediate professional help from a mental health crisis helpline, a mental health hotline, or go to the nearest emergency room. Safety should be the top priority. \n 2.  Comprehensive Assessment: Consult with a mental health professional to conduct a thorough assessment of your condition. They can recommend an appropriate treatment plan, which may include a combination of therapy, medication, and other interventions. \n 3.  Medication Management: If prescribed medication, adhere to the prescribed regimen and attend regular follow-up appointments with your healthcare provider. \n 4.  Therapy: Engage in therapy or counseling with a mental health professional who specializes in treating severe depression. Evidence-based therapies such as Cognitive Behavioral Therapy (CBT), Dialectical Behavior Therapy (DBT), or Electroconvulsive Therapy (ECT) may be considered.";
                            }
                            break;
                        case 1:
                            if (score >= 0 && score <= 4) {
                                result.textContent = "You have minimal level of anxiety.";
                            }
                            else if (score >= 5 && score <= 9) {
                                result.textContent = "You have mild level of anxiety. Here are some lifestyle changes that might help: \n \n1.  Regular Exercise: Engage in regular physical activity, such as walking, jogging, or yoga. Exercise releases endorphins, which are natural mood lifters and can help reduce anxiety.\n 2.  Healthy Diet: Maintain a balanced diet with plenty of fruits, vegetables, whole grains, lean proteins, and healthy fats. Avoid excessive caffeine, sugar, and processed foods, as they can exacerbate anxiety.\n 3.  Adequate Sleep: Ensure you get enough quality sleep. Develop a consistent sleep schedule and create a bedtime routine to improve your sleep quality.\n 4.  Stress Management: Practice stress-reduction techniques like meditation, deep breathing, progressive muscle relaxation, or mindfulness. These can help you manage stress and anxiety effectively.\n 5.  Limit Alcohol and Caffeine: Reduce your intake of alcohol and caffeine, as they can worsen anxiety symptoms.";
                            }
                            else if (score >= 10 && score <= 14) {
                                result.textContent = "You have moderate level of anxiety. Here are some lifestyle changes that might help: \n \n1.  Consult a Mental Health Professional: Reach out to a therapist, counselor, or psychiatrist. They can provide a formal assessment and recommend the most appropriate treatment, which may include therapy and, in some cases, medication.\n2.  Therapy: Engage in therapy, such as cognitive-behavioral therapy (CBT), dialectical behavior therapy (DBT), or exposure therapy, to address and manage your anxiety effectively. Therapy provides you with tools and coping strategies tailored to your needs.\n3.  Medication: If deemed necessary by a mental health professional, consider medication for anxiety management. Antidepressants and anti-anxiety medications can be effective in reducing symptoms.\n 4.  Regular Exercise: Incorporate regular physical activity into your routine. Exercise helps to reduce anxiety by releasing endorphins and promoting overall well-being.\n 5.  Healthy Diet: Maintain a balanced diet that includes whole foods, plenty of fruits and vegetables, lean proteins, and healthy fats. Avoid excessive caffeine, sugar, and processed foods, which can exacerbate anxiety.\n 6.  Adequate Sleep: Prioritize sleep and work on improving your sleep hygiene. Quality sleep is essential for managing anxiety.\n 7.  Stress Management: Practice stress-reduction techniques daily, such as mindfulness, meditation, deep breathing, or progressive muscle relaxation.\n 8.  Limit Alcohol and Caffeine: Reduce or eliminate alcohol and caffeine, as they can increase anxiety symptoms.";
                            }

                            else {
                                result.textContent = "You are probably suffering from severe anxiety disorder. Here are some lifestyle changes that might help: \n \n1.  Consult a Mental Health Professional: Reach out to a therapist, counselor, or psychiatrist immediately. They can provide a formal assessment and recommend the most appropriate treatment, which may include therapy, medication, or a combination of both.\n 2.  Therapy: Engage in therapy, such as cognitive-behavioral therapy (CBT), dialectical behavior therapy (DBT), exposure therapy, or intensive outpatient programs. These therapies are specifically designed to address and manage severe anxiety.\n 3.  Medication: If recommended by a mental health professional, consider medication for anxiety management. Antidepressants, anti-anxiety medications, or mood stabilizers may be prescribed.\n 4.  Support System: Build a strong support system with family and friends who can provide emotional assistance. Consider joining support groups for individuals with severe anxiety.\n 5.  Regular Exercise: Incorporate regular physical activity into your routine to release endorphins and reduce anxiety. Consult your healthcare provider to ensure it's safe and suitable for your condition.\n 6.  Healthy Diet: Maintain a balanced diet rich in whole foods, fruits, vegetables, lean proteins, and healthy fats. Avoid caffeine, sugar, and processed foods that can exacerbate anxiety.\n 7.  Adequate Sleep: Prioritize sleep and work on improving your sleep hygiene, as quality sleep is essential for managing anxiety.";
                            }
                            break;
                        case 2:
                            if (score >= 0 && score <= 13) {
                                result.textContent = "It doesn't seem like you are suffering from stress";
                            } else if (score >= 14 && score <= 26) {
                                result.textContent = "You seem to be suffering from moderate levels of stress. Here are some lifestyle changes that might help: \n \n1.  Prioritize Self-Care: Make self-care a non-negotiable part of your routine. This can include activities like taking warm baths, practicing meditation, or enjoying hobbies you love. \n 2.  Regular Exercise: Engage in regular physical activity to help your body release endorphins, which are natural stress relievers. Aim for at least 30 minutes of exercise most days of the week.\n 3.  Healthy Diet: Eat a balanced diet with plenty of fruits, vegetables, whole grains, lean proteins, and healthy fats. Avoid excessive caffeine and sugar, which can exacerbate stress.\n 4.  Adequate Sleep: Ensure you get enough restorative sleep. Most adults need 7-9 hours of sleep per night. A consistent sleep schedule can help.\n 5.  Stress Management: Practice stress-reduction techniques such as mindfulness, deep breathing, progressive muscle relaxation, or yoga.\n 6.  Limit Exposure to Stressors: Identify sources of stress in your life and consider ways to reduce or eliminate them if possible.\n 7.  Hobbies and Recreation: Engage in activities and hobbies that you enjoy and that help you relax and unwind.";
                            } else {
                                result.textContent = "You seem to be suffering from high levels of stress. Here are some lifestyle changes that might help: \n \n1.  Consult a Mental Health Professional: If you are experiencing high levels of stress, it's important to reach out to a mental health professional, such as a therapist or counselor, for support and guidance.\n 2.  Self-Care: Prioritize self-care and allocate time for activities that help you relax and unwind. This can include taking breaks, practicing relaxation techniques, and engaging in hobbies you enjoy.\n 3.  Regular Exercise: Incorporate regular physical activity into your routine, as exercise can help release endorphins, which are natural stress relievers. Aim for at least 30 minutes of moderate exercise most days of the week.\n 4.  Healthy Diet: Maintain a balanced diet with plenty of fruits, vegetables, whole grains, lean proteins, and healthy fats. Avoid excessive caffeine, sugar, and processed foods, as they can exacerbate stress.\n 5.  Adequate Sleep: Ensure you get enough quality sleep. Establish a consistent sleep schedule and create a bedtime routine to improve sleep quality.\n 6.  Stress Management Techniques: Practice stress-reduction techniques such as mindfulness, meditation, deep breathing exercises, progressive muscle relaxation, or yoga.\n 7.  Limit Alcohol and Caffeine: Reduce or eliminate alcohol and caffeine intake, as they can worsen stress and disrupt sleep patterns.";
                            }
                            break;
                        case 3:
                            if (score > 44) {
                                result.textContent = "It seems you may possibly be suffering from PTSD";
                            } else {
                                result.textContent = "It doesn't seem like you are suffering from PTSD. Here are some lifestyle changes that might help: \n \n1.  Consult a Mental Health Professional: If you suspect you have PTSD, it is essential to seek professional help. A therapist or psychiatrist can provide you with the most appropriate treatment plan, which may include therapy and medication.\n 2.  Counseling and Therapy: Engage in therapy, specifically evidence-based treatments like Cognitive-Behavioral Therapy (CBT) and Eye Movement Desensitization and Reprocessing (EMDR), which have been shown to be effective for PTSD.\n 3.  Medication: If prescribed by a mental health professional, medication such as antidepressants or anti-anxiety drugs may be used to manage specific symptoms.\n 4.  Healthy Lifestyle: Focus on maintaining a healthy lifestyle, including a balanced diet, regular exercise, and adequate sleep. These factors can help improve your overall well-being and resilience.\n 5.  Engage in Positive Activities: Participate in activities you enjoy and that promote positive feelings, such as hobbies, art, or volunteering.\n 6.  Limit Exposure to Triggers: Identify and minimize exposure to triggers related to the traumatic event as much as possible. This can include avoiding specific places or situations that trigger distressing memories.\n 7.  Journaling: Consider keeping a journal to express your thoughts and emotions, which can help you process and understand your experiences.\n 8.  Self-Care: Prioritize self-care and practice self-compassion. Be kind and patient with yourself as you work through your PTSD.";
                            }
                            break;
                        case 4:
                            break;
                        case 5:
                            break;
                        case 6:
                            break;
                        case 7:
                            break;
                    }



                    chatbox.appendChild(result);
                    testButtonEnabled = true;
                    console.log(responseList);
                    var commaSeparatedString = responseList.join(',');
                    console.log(commaSeparatedString);
                    const csrftoken = getCookie("csrftoken");
                    $.ajax({
                        type: "POST",
                        url: "/save_survey/",
                        headers: {
                            "X-CSRFToken": csrftoken
                        },
                        data: {
                            "survey_no": selectedSurvey,
                            "response": commaSeparatedString,
                        },
                        success: function (result) {
                            console.log(result);

                        },
                        dataType: "json"
                    });
                }
            }

            renderNextQuestion();

        }

        function startNewSurvey(surveyData, selectedSurvey, survey_labels) {
            surveyCompleted = false;

            currentSurveyProgress = 0;
            renderSurvey(surveyData, selectedSurvey, survey_labels);
        }

        testButton.addEventListener("click", function () {

            if (testButtonEnabled) {
                testButtonEnabled = false;
                const chat_box = document.getElementById('chatbox');
                const choice = document.createElement('div')
                choice.className = "message bot-message";
                choice.textContent = "Choose the test you want to take";
                chat_box.appendChild(choice);
                const optionContainer = document.createElement('div');
                optionContainer.className = 'options-container';
                const radioButtons = [];
                const labels = [
                    "Depression", "Anxiety", "Stress", "PTSD",
                ]; //"Addiction", "Bipolar Disorder", "Eating Disorder", "Schizophrenia"
                for (let j = 0; j < labels.length; j++) {
                    const button = document.createElement('input');
                    button.type = 'radio';
                    button.name = 'survey_options' + String(radioButtonIndex);
                    button.value = j;
                    radioButtons.push(button);
                }
                radioButtonIndex++;


                for (let j = 0; j < labels.length; j++) {
                    const label = document.createElement('label');
                    label.textContent = labels[j];
                    const option = document.createElement('div');
                    option.className = 'option';
                    option.appendChild(radioButtons[j]);
                    option.appendChild(label);
                    optionContainer.appendChild(option);
                }

                chatbox.appendChild(optionContainer);

                const nextButton = document.createElement('button');
                nextButton.textContent = 'Next';
                nextButton.className = 'next-button';
                nextButton.id = "next_button";

                let selectedValue = null;

                radioButtons.forEach(function (radioButton) {
                    radioButton.addEventListener('change', function () {
                        if (this.checked) {
                            selectedValue = parseInt(this.value); // Parse the value as an integer
                            console.log(selectedValue);
                        }
                    });
                });


                chat_box.appendChild(nextButton);
                nextButton.addEventListener('click', function () {
                    if (selectedValue != null) {
                        nextButton.remove();

                        $.ajax({
                            url: "/load_survey/",
                            method: "GET",
                            success: function (data) {

                                let survey_data = null;
                                let survey_labels = null;

                                switch (selectedValue) {
                                    case 0:
                                        survey_data = data.depression;
                                        survey_labels = data.depression_labels;
                                        break;
                                    case 1:
                                        survey_data = data.anxiety;
                                        survey_labels = data.anxiety_labels;
                                        break;
                                    case 2:
                                        survey_data = data.stress;
                                        survey_labels = data.stress_labels;
                                        break;
                                    case 3:
                                        survey_data = data.ptsd;
                                        survey_labels = data.ptsd_labels;
                                        break;
                                    case 4:
                                        survey_data = data.addiction;
                                        survey_labels = data.addiction_labels;
                                        break;
                                    case 5:
                                        survey_data = data.bipolar;
                                        survey_labels = data.bipolar_labels;
                                        break;
                                    case 6:
                                        survey_data = data.eating;
                                        survey_labels = data.eating_labels;
                                        break;
                                    case 7:
                                        survey_data = data.schizophrenia;
                                        survey_labels = data.schizophrenia_labels;
                                        break;
                                }

                                if (surveyCompleted || currentSurveyProgress == 0) {
                                    startNewSurvey(survey_data, selectedValue, survey_labels);
                                } else {
                                    renderSurvey(survey_data, selectedValue, survey_labels);
                                }


                                const nextButton = document.querySelector('.next-button');
                                if (nextButton) {
                                    nextButton.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }
                            },
                            error: function (xhr, status, error) {
                                console.error("Error:", error);
                            }
                        });
                    }
                });
            }

        });



        $.ajax({
            url: "/load_chats/",
            method: "GET",
            success: function (data) {
                const chatHistoryList = document.getElementById('chatHistoryList');

                data.dates.forEach((chatItem) => {

                    const listItem = document.createElement('li');
                    listItem.textContent = chatItem.date;
                    listItem.className = 'chat-date';


                    listItem.addEventListener('click', function () {

                        const selectedDate = chatItem.date;

                        $.ajax({
                            url: "/load_chat/",
                            method: "GET",
                            data: { date: selectedDate },
                            success: function (chatData) {
                                console.log(chatData);
                                renderChatMessages(chatData.chat);
                            },
                            error: function (xhr, status, error) {
                                console.error("Error:", error);
                            }
                        });
                    });

                    chatHistoryList.appendChild(listItem);

                });
            },
            error: function (xhr, status, error) {
                console.error("Error:", error);
            }
        });



        addDivForm.addEventListener("submit", function (event) {

            event.preventDefault();
            const userMessage = document.querySelector('input[name="message"]').value;
            const csrftoken = getCookie("csrftoken");
            if (testButtonEnabled) {
                $.ajax({
                    url: "/chat_data/",
                    method: "POST",
                    headers: {
                        "X-CSRFToken": csrftoken
                    },
                    data: { message: userMessage },
                    success: function (data) {
                        const botResponse = document.createElement("div");
                        botResponse.className = "message bot-message";
                        botResponse.textContent = data.response;

                        const userResponse = document.createElement("div");
                        userResponse.className = "message user-message";
                        userResponse.textContent = data.message;

                        container.appendChild(userResponse);
                        container.appendChild(botResponse);

                        // Scroll to the latest message
                        container.scrollTop = container.scrollHeight;
                    },
                    error: function (xhr, status, error) {
                        console.error("Error:", error);
                    }
                });
            }
            document.querySelector('input[name="message"]').value = "";

        });


        function loadSavedSurvey(surveyNo, options, callback) {
            const chat_box = document.getElementById('chatbox');
            const choice = document.createElement('div')
            choice.className = "message bot-message";
            choice.textContent = "Choose the test you want to take";
            chat_box.appendChild(choice);
            const optionContainer = document.createElement('div');
            optionContainer.className = 'options-container';
            const radioButtons = [];
            const labels = [
                "Depression", "Anxiety", "Stress", "PTSD",
            ]; //"Addiction", "Bipolar Disorder", "Eating Disorder", "Schizophrenia"
            for (let j = 0; j < labels.length; j++) {
                const button = document.createElement('input');
                button.type = 'radio';
                button.name = 'survey_options' + String(radioButtonIndex);
                button.value = j;
                button.disabled = true;
                radioButtons.push(button);
            }
            radioButtonIndex++;


            for (let j = 0; j < labels.length; j++) {
                const label = document.createElement('label');
                label.textContent = labels[j];
                const option = document.createElement('div');
                option.className = 'option';
                option.appendChild(radioButtons[j]);
                option.appendChild(label);
                optionContainer.appendChild(option);
            }
            radioButtons[surveyNo].checked = true;
            chatbox.appendChild(optionContainer);

            $.ajax({
                url: "/load_survey/",
                method: "GET",
                success: function (data) {

                    let survey_data = null;
                    let survey_labels = null;
                    surveyId = parseInt(surveyNo);
                    switch (surveyId) {
                        case 0:

                            survey_data = data.depression;
                            survey_labels = data.depression_labels;
                            break;
                        case 1:
                            survey_data = data.anxiety;
                            survey_labels = data.anxiety_labels;
                            break;
                        case 2:
                            survey_data = data.stress;
                            survey_labels = data.stress_labels;
                            break;
                        case 3:
                            survey_data = data.ptsd;
                            survey_labels = data.ptsd_labels;
                            break;
                        case 4:
                            survey_data = data.addiction;
                            survey_labels = data.addiction_labels;
                            break;
                        case 5:
                            survey_data = data.bipolar;
                            survey_labels = data.bipolar_labels;
                            break;
                        case 6:
                            survey_data = data.eating;
                            survey_labels = data.eating_labels;
                            break;
                        case 7:
                            survey_data = data.schizophrenia;
                            survey_labels = data.schizophrenia_labels;
                            break;
                    }
                    renderSavedSurvey(survey_data, surveyNo, survey_labels, options, callback);
                },
                error: function (xhr, status, error) {
                    console.error("Error:", error);
                }
            });
        }



        function renderSavedSurvey(questions, selectedSurvey, labels, options_data, callback) {
            const chatbox = document.getElementById('chatbox');
            const heading = document.createElement('div');
            heading.className = "message bot-message";
            heading.textContent = "Over the last two weeks, how often have you been bothered by any of the following problems?";
            chatbox.appendChild(heading);
            const result = document.createElement('div');
            result.className = "message bot-message";
            var i = 0;
            var elem;
            const responseList = [];
            var score = 0;
            console.log(options_data);
            const options = options_data.split(",");
            console.log("starting");
            function renderNextQuestion() {
                if (i < questions.length) {

                    console.log("iteration : ");

                    const question = questions[i];
                    const questionDiv = document.createElement('div');
                    const optionContainer = document.createElement('div');
                    optionContainer.className = 'options-container';
                    questionDiv.className = 'message bot-message';
                    questionDiv.textContent = question;

                    chatbox.appendChild(questionDiv);
                    

                    const radioButtons = [];

                    let selectedValue = parseInt(options[i]);
                    score += selectedValue;
                    console.log(selectedValue);
                    if (selectedSurvey == 2) {
                        if (i == 3 || i == 4 || i == 6 || i == 7) {
                            selectedValue = 4 - selectedValue;
                        }
                    }
                    
                    for (let j = 0; j < labels.length; j++) {
                        const button = document.createElement('input');
                        button.type = 'radio';
                        button.name = 'survey_options' + String(radioButtonIndex);
                        button.value = j;
                        button.disabled = true;
                        radioButtons.push(button);
                    }

                    radioButtons[selectedValue].checked = true;
                    radioButtonIndex++;
                    


                    for (let j = 0; j < labels.length; j++) {
                        const label = document.createElement('label');
                        label.textContent = labels[j];
                        const option = document.createElement('div');
                        option.className = 'option';
                        option.appendChild(radioButtons[j]);
                        option.appendChild(label);
                        optionContainer.appendChild(option);
                    }

                    chatbox.appendChild(optionContainer);
                    i++;
                    renderNextQuestion();
                } else {
                    console.log('survey complete');

                    switch (parseInt(selectedSurvey)) {
                        case 0:
                            if (score >= 0 && score <= 4) {
                                result.textContent = "You have no symptoms of depression";
                            } else if (score >= 5 && score <= 9) {
                                result.textContent = "It seems you have mild symptoms of depression. Here are some lifestyle changes that might help: \n \n1.  Exercise Regularly: Physical activity can boost mood and reduce symptoms of depression. Aim for at least 30 minutes of moderate exercise most days of the week. \n  2.  Maintain a Healthy Diet: Eating a balanced diet with plenty of fruits, vegetables, whole grains, and lean proteins can have a positive impact on your mood. \n 3.  Get Adequate Sleep: Make sure you're getting enough quality sleep, as sleep deprivation can worsen depression symptoms. Try to maintain a consistent sleep schedule. \n 4.  Connect with Others: Social support is crucial. Stay connected with friends and family, and consider talking to a therapist or counselor for additional support. \n  5.  Limit Alcohol and Caffeine: Excessive alcohol and caffeine consumption can worsen depression symptoms. It's best to consume them in moderation or avoid them altogether.";
                            } else if (score >= 10 && score <= 14) {
                                result.textContent = "It seems you have moderate symptoms of depression. Here are some lifestyle changes that might help: \n \n1.  Seek Professional Help: If you're experiencing moderate symptoms of depression, it's crucial to consult with a mental health professional, such as a therapist, psychiatrist, or counselor, who can provide you with tailored treatment options, including therapy and potentially medication. \n 2.  Maintain a Daily Routine: Establishing a structured daily routine can provide a sense of stability and purpose. This includes setting regular sleep and meal times. \n 3.  Exercise Regularly: Physical activity can improve mood and reduce depression symptoms. Aim for at least 30 minutes of moderate exercise on most days. \n  4.  Healthy Eating: Consume a balanced diet rich in fruits, vegetables, whole grains, and lean proteins. Proper nutrition can support your overall well-being. \n 5.  Adequate Sleep: Ensure you are getting enough quality sleep, and try to maintain a consistent sleep schedule.";
                            } else if (score >= 15 && score <= 19) {
                                result.textContent = "It seems you have moderately severe depression. Here are some lifestyle changes that might help: \n \n1.  Seek Immediate Professional Help: If you or someone you know is experiencing moderately severe depression, it's critical to consult with a mental health professional or psychiatrist as soon as possible. They can provide a comprehensive assessment and recommend appropriate treatment, which may include therapy, medication, or a combination of both. \n 2.  Safety First: If you or someone you know is in crisis or experiencing thoughts of self-harm or suicide, please seek immediate help from a crisis helpline, a mental health hotline, or go to the nearest emergency room. Safety is the top priority. \n 3.  Medication Management: If prescribed medication, it's important to take it as directed by your healthcare provider and attend regular follow-up appointments. \n 3.  Medication Management: If prescribed medication, it's important to take it as directed by your healthcare provider and attend regular follow-up appointments. \n 4.  Therapy: Consider engaging in therapy or counseling. Cognitive Behavioral Therapy (CBT), Dialectical Behavior Therapy (DBT), and other evidence-based therapeutic approaches can be effective in managing depression. \n 5.  Support System: Lean on a support network of friends and family. You don't have to go through depression alone, and loved ones can provide emotional support.";
                            } else {
                                result.textContent = "Your symptoms seems like of severe depression. Here are some lifestyle changes that might help: \n \n1.  Urgent Professional Help: If you believe you have severe symptoms of depression or are experiencing thoughts of self-harm or suicide, it's critical to seek immediate professional help from a mental health crisis helpline, a mental health hotline, or go to the nearest emergency room. Safety should be the top priority. \n 2.  Comprehensive Assessment: Consult with a mental health professional to conduct a thorough assessment of your condition. They can recommend an appropriate treatment plan, which may include a combination of therapy, medication, and other interventions. \n 3.  Medication Management: If prescribed medication, adhere to the prescribed regimen and attend regular follow-up appointments with your healthcare provider. \n 4.  Therapy: Engage in therapy or counseling with a mental health professional who specializes in treating severe depression. Evidence-based therapies such as Cognitive Behavioral Therapy (CBT), Dialectical Behavior Therapy (DBT), or Electroconvulsive Therapy (ECT) may be considered.";
                            }
                            break;
                        case 1:
                            if (score >= 0 && score <= 4) {
                                result.textContent = "You have no symptoms of anxiety.";
                            }
                            else if (score >= 5 && score <= 9) {
                                result.textContent = "You have mild level of anxiety. Here are some lifestyle changes that might help: \n \n1.  Regular Exercise: Engage in regular physical activity, such as walking, jogging, or yoga. Exercise releases endorphins, which are natural mood lifters and can help reduce anxiety.\n 2.  Healthy Diet: Maintain a balanced diet with plenty of fruits, vegetables, whole grains, lean proteins, and healthy fats. Avoid excessive caffeine, sugar, and processed foods, as they can exacerbate anxiety.\n 3.  Adequate Sleep: Ensure you get enough quality sleep. Develop a consistent sleep schedule and create a bedtime routine to improve your sleep quality.\n 4.  Stress Management: Practice stress-reduction techniques like meditation, deep breathing, progressive muscle relaxation, or mindfulness. These can help you manage stress and anxiety effectively.\n 5.  Limit Alcohol and Caffeine: Reduce your intake of alcohol and caffeine, as they can worsen anxiety symptoms.";
                            }
                            else if (score >= 10 && score <= 14) {
                                result.textContent = "You have moderate level of anxiety. Here are some lifestyle changes that might help: \n \n1.  Consult a Mental Health Professional: Reach out to a therapist, counselor, or psychiatrist. They can provide a formal assessment and recommend the most appropriate treatment, which may include therapy and, in some cases, medication.\n2.  Therapy: Engage in therapy, such as cognitive-behavioral therapy (CBT), dialectical behavior therapy (DBT), or exposure therapy, to address and manage your anxiety effectively. Therapy provides you with tools and coping strategies tailored to your needs.\n3.  Medication: If deemed necessary by a mental health professional, consider medication for anxiety management. Antidepressants and anti-anxiety medications can be effective in reducing symptoms.\n 4.  Regular Exercise: Incorporate regular physical activity into your routine. Exercise helps to reduce anxiety by releasing endorphins and promoting overall well-being.\n 5.  Healthy Diet: Maintain a balanced diet that includes whole foods, plenty of fruits and vegetables, lean proteins, and healthy fats. Avoid excessive caffeine, sugar, and processed foods, which can exacerbate anxiety.\n 6.  Adequate Sleep: Prioritize sleep and work on improving your sleep hygiene. Quality sleep is essential for managing anxiety.\n 7.  Stress Management: Practice stress-reduction techniques daily, such as mindfulness, meditation, deep breathing, or progressive muscle relaxation.\n 8.  Limit Alcohol and Caffeine: Reduce or eliminate alcohol and caffeine, as they can increase anxiety symptoms.";
                            }

                            else {
                                result.textContent = "You are probably suffering from severe anxiety disorder. Here are some lifestyle changes that might help: \n \n1.  Consult a Mental Health Professional: Reach out to a therapist, counselor, or psychiatrist immediately. They can provide a formal assessment and recommend the most appropriate treatment, which may include therapy, medication, or a combination of both.\n 2.  Therapy: Engage in therapy, such as cognitive-behavioral therapy (CBT), dialectical behavior therapy (DBT), exposure therapy, or intensive outpatient programs. These therapies are specifically designed to address and manage severe anxiety.\n 3.  Medication: If recommended by a mental health professional, consider medication for anxiety management. Antidepressants, anti-anxiety medications, or mood stabilizers may be prescribed.\n 4.  Support System: Build a strong support system with family and friends who can provide emotional assistance. Consider joining support groups for individuals with severe anxiety.\n 5.  Regular Exercise: Incorporate regular physical activity into your routine to release endorphins and reduce anxiety. Consult your healthcare provider to ensure it's safe and suitable for your condition.\n 6.  Healthy Diet: Maintain a balanced diet rich in whole foods, fruits, vegetables, lean proteins, and healthy fats. Avoid caffeine, sugar, and processed foods that can exacerbate anxiety.\n 7.  Adequate Sleep: Prioritize sleep and work on improving your sleep hygiene, as quality sleep is essential for managing anxiety.";
                            }
                            break;
                        case 2:
                            if (score >= 0 && score <= 13) {
                                result.textContent = "It doesn't seem like you are suffering from stress";
                            } else if (score >= 14 && score <= 26) {
                                result.textContent = "You seem to be suffering from moderate levels of stress. Here are some lifestyle changes that might help: \n \n1.  Prioritize Self-Care: Make self-care a non-negotiable part of your routine. This can include activities like taking warm baths, practicing meditation, or enjoying hobbies you love. \n 2.  Regular Exercise: Engage in regular physical activity to help your body release endorphins, which are natural stress relievers. Aim for at least 30 minutes of exercise most days of the week.\n 3.  Healthy Diet: Eat a balanced diet with plenty of fruits, vegetables, whole grains, lean proteins, and healthy fats. Avoid excessive caffeine and sugar, which can exacerbate stress.\n 4.  Adequate Sleep: Ensure you get enough restorative sleep. Most adults need 7-9 hours of sleep per night. A consistent sleep schedule can help.\n 5.  Stress Management: Practice stress-reduction techniques such as mindfulness, deep breathing, progressive muscle relaxation, or yoga.\n 6.  Limit Exposure to Stressors: Identify sources of stress in your life and consider ways to reduce or eliminate them if possible.\n 7.  Hobbies and Recreation: Engage in activities and hobbies that you enjoy and that help you relax and unwind.";
                            } else {
                                result.textContent = "You seem to be suffering from high levels of stress. Here are some lifestyle changes that might help: \n \n1.  Consult a Mental Health Professional: If you are experiencing high levels of stress, it's important to reach out to a mental health professional, such as a therapist or counselor, for support and guidance.\n 2.  Self-Care: Prioritize self-care and allocate time for activities that help you relax and unwind. This can include taking breaks, practicing relaxation techniques, and engaging in hobbies you enjoy.\n 3.  Regular Exercise: Incorporate regular physical activity into your routine, as exercise can help release endorphins, which are natural stress relievers. Aim for at least 30 minutes of moderate exercise most days of the week.\n 4.  Healthy Diet: Maintain a balanced diet with plenty of fruits, vegetables, whole grains, lean proteins, and healthy fats. Avoid excessive caffeine, sugar, and processed foods, as they can exacerbate stress.\n 5.  Adequate Sleep: Ensure you get enough quality sleep. Establish a consistent sleep schedule and create a bedtime routine to improve sleep quality.\n 6.  Stress Management Techniques: Practice stress-reduction techniques such as mindfulness, meditation, deep breathing exercises, progressive muscle relaxation, or yoga.\n 7.  Limit Alcohol and Caffeine: Reduce or eliminate alcohol and caffeine intake, as they can worsen stress and disrupt sleep patterns.";
                            }
                            break;
                        case 3:
                            if (score < 44) {
                                result.textContent = "It doesn't seem you are suffering from PTSD";
                            } else {
                                result.textContent = "It seems you may possibly be suffering from PTSD. Here are some lifestyle changes that might help: \n \n1.  Consult a Mental Health Professional: If you suspect you have PTSD, it is essential to seek professional help. A therapist or psychiatrist can provide you with the most appropriate treatment plan, which may include therapy and medication.\n 2.  Counseling and Therapy: Engage in therapy, specifically evidence-based treatments like Cognitive-Behavioral Therapy (CBT) and Eye Movement Desensitization and Reprocessing (EMDR), which have been shown to be effective for PTSD.\n 3.  Medication: If prescribed by a mental health professional, medication such as antidepressants or anti-anxiety drugs may be used to manage specific symptoms.\n 4.  Healthy Lifestyle: Focus on maintaining a healthy lifestyle, including a balanced diet, regular exercise, and adequate sleep. These factors can help improve your overall well-being and resilience.\n 5.  Engage in Positive Activities: Participate in activities you enjoy and that promote positive feelings, such as hobbies, art, or volunteering.\n 6.  Limit Exposure to Triggers: Identify and minimize exposure to triggers related to the traumatic event as much as possible. This can include avoiding specific places or situations that trigger distressing memories.\n 7.  Journaling: Consider keeping a journal to express your thoughts and emotions, which can help you process and understand your experiences.\n 8.  Self-Care: Prioritize self-care and practice self-compassion. Be kind and patient with yourself as you work through your PTSD.";
                            }
                            break;
                        case 4:
                            break;
                        case 5:
                            break;
                        case 6:
                            break;
                        case 7:
                            break;
                    }



                    chatbox.appendChild(result);

                }

            }
            renderNextQuestion();
            callback();
        }
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== "") {
                const cookies = document.cookie.split(";");
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === name + "=") {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

</body>

</html>